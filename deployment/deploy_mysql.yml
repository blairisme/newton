---
# Newton (c)
#
# This work is licensed under the MIT License. To view a copy of this
# license, visit
#
#      https://opensource.org/licenses/MIT
#
# This script installs and configures MySQL on a given server.
#
# Author: Blair Butterworth
#
- name: Register MySQL repository
  yum:
    name: https://dev.mysql.com/get/mysql80-community-release-el7-1.noarch.rpm
    state: present

- name: Check if MySQL Installed
  command: yum info mysql-community-server
  register: install_check

- name: Install MySQL
  yum:
    name: "{{ item }}"
    state: present
  with_items:
    - mysql-server
    - MySQL-python

- name: Start MySQL
  service:
    name: mysqld
    state: started
    enabled: yes

- name: Update MySQL password
  shell: |
    initial_password=`awk '/A temporary password is generated for/ {a=$0} END{ print a }' /var/log/mysqld.log | awk '{print $(NF)}'`
    mysql -uroot -p"${initial_password}" --connect-expired-password -e "ALTER USER 'root'@'localhost' IDENTIFIED BY '{{ mysql_root_password }}'; flush privileges; "
  when: install_check.stdout.find('No matching Packages to list') != -1
